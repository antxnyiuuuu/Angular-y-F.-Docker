<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador - TravelApp</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="../assets/additional-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="logo">
                    <i class="fas fa-plane"></i>
                    TravelApp Admin
                </h1>
                <div class="user-menu">
                    <span class="user-name" id="adminNameDisplay">Admin</span>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="main-nav">
            <div class="nav-container">
                <button class="nav-link active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>
                <button class="nav-link" onclick="showSection('products')">
                    <i class="fas fa-box"></i>
                    Productos
                </button>
                <button class="nav-link" onclick="showSection('packages')">
                    <i class="fas fa-suitcase"></i>
                    Paquetes
                </button>
                <button class="nav-link" onclick="showSection('users')">
                    <i class="fas fa-users"></i>
                    Usuarios
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main">
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="content-section active">
                <div class="page-header">
                    <h2>Dashboard Administrativo</h2>
                    <p>Resumen general del sistema</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalProducts">0</h3>
                            <p>Total Productos</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-suitcase"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalPackages">0</h3>
                            <p>Total Paquetes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalUsers">0</h3>
                            <p>Total Usuarios</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalRevenue">$0</h3>
                            <p>Ingresos Totales</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-content">
                    <div class="dashboard-section">
                        <h3>Productos por Categoría</h3>
                        <div id="productsByCategory" class="category-stats">
                            <!-- Se cargarán dinámicamente -->
                        </div>
                    </div>

                    <div class="dashboard-section">
                        <h3>Paquetes Recientes</h3>
                        <div id="recentPackages" class="packages-list">
                            <!-- Se cargarán dinámicamente -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products Section -->
            <section id="productsSection" class="content-section">
                <div class="page-header">
                    <h2>Gestión de Productos</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                        <button class="btn btn-secondary" onclick="showCreatePackageModal()">
                            <i class="fas fa-suitcase"></i> Crear Paquete
                        </button>
                    </div>
                </div>

                <div class="products-tabs">
                    <button class="tab-btn active" onclick="showProductCategory('hoteles')">
                        <i class="fas fa-bed"></i> Hoteles
                    </button>
                    <button class="tab-btn" onclick="showProductCategory('restaurantes')">
                        <i class="fas fa-utensils"></i> Restaurantes
                    </button>
                    <button class="tab-btn" onclick="showProductCategory('actividades')">
                        <i class="fas fa-hiking"></i> Actividades
                    </button>
                    <button class="tab-btn" onclick="showProductCategory('comidas')">
                        <i class="fas fa-coffee"></i> Comidas
                    </button>
                </div>

                <div id="productsList" class="products-grid">
                    <!-- Se cargarán dinámicamente -->
                </div>
            </section>

            <!-- Packages Section -->
            <section id="packagesSection" class="content-section">
                <div class="page-header">
                    <h2>Gestión de Paquetes</h2>
                </div>

                <div id="adminPackagesList" class="packages-grid">
                    <!-- Se cargarán dinámicamente -->
                </div>
            </section>

            <!-- Users Section -->
            <section id="usersSection" class="content-section">
                <div class="page-header">
                    <h2>Gestión de Usuarios</h2>
                </div>

                <div id="usersList" class="users-grid">
                    <!-- Se cargarán dinámicamente -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para agregar producto -->
    <div id="addProductModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Agregar Producto</h3>
                <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
            </div>
            <div class="modal-content">
                <form id="addProductForm">
                    <div class="form-group">
                        <label for="productName">Nombre</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productDescription">Descripción</label>
                        <textarea id="productDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Precio</label>
                        <input type="number" id="productPrice" required>
                    </div>
                    <div class="form-group">
                        <label for="productLocation">Localidad</label>
                        <select id="productLocation" required>
                            <!-- Se cargarán dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productImage">URL de Imagen</label>
                        <input type="url" id="productImage" required>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para crear paquete -->
    <div id="createPackageModal" class="modal-overlay" style="display: none;">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3>Crear Paquete</h3>
                <button class="modal-close" onclick="closeCreatePackageModal()">&times;</button>
            </div>
            <div class="modal-content">
                <form id="createPackageForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="packageName">Nombre del Paquete</label>
                            <input type="text" id="packageName" required>
                        </div>
                        <div class="form-group">
                            <label for="packageLocation">Localidad</label>
                            <select id="packageLocation" required>
                                <!-- Se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="packageDescription">Descripción</label>
                        <textarea id="packageDescription" required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="packageDuration">Duración (días)</label>
                            <input type="number" id="packageDuration" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="packagePrice">Precio Base</label>
                            <input type="number" id="packagePrice" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="packageProducts">Productos Incluidos</label>
                        <div id="packageProductsList" class="products-selection">
                            <!-- Se cargarán dinámicamente -->
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreatePackageModal()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Crear Paquete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../data/products.js"></script>
    <script src="../assets/app.js"></script>
    <script>
        let currentUser = null;
        let currentProductCategory = 'hoteles';

        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay usuario logueado
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(storedUser);
            if (currentUser.type !== 'admin') {
                window.location.href = 'user.html';
                return;
            }

            document.getElementById('adminNameDisplay').textContent = currentUser.name;
            initializeAdminPage();
            
            // Configurar eventos de formularios
            setupFormEvents();
        });

        function setupFormEvents() {
            // Evento para crear paquete
            const createPackageForm = document.getElementById('createPackageForm');
            if (createPackageForm) {
                createPackageForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    createPackage();
                });
            }
        }

        function createPackage() {
            const name = document.getElementById('packageName').value;
            const location = document.getElementById('packageLocation').value;
            const description = document.getElementById('packageDescription').value;
            const duration = document.getElementById('packageDuration').value;
            const price = document.getElementById('packagePrice').value;

            // Obtener productos seleccionados
            const selectedProducts = [];
            document.querySelectorAll('#packageProductsList input[type="checkbox"]:checked').forEach(checkbox => {
                const productId = parseInt(checkbox.value);
                // Buscar el producto en todos los arrays
                const allProducts = [
                    ...products.hoteles.map(p => ({...p, categoria: 'hoteles'})),
                    ...products.restaurantes.map(p => ({...p, categoria: 'restaurantes'})),
                    ...products.actividades.map(p => ({...p, categoria: 'actividades'})),
                    ...products.comidas.map(p => ({...p, categoria: 'comidas'}))
                ];
                const product = allProducts.find(p => p.id === productId);
                if (product) {
                    selectedProducts.push(product);
                }
            });

            const newPackage = {
                id: Date.now(),
                nombre: name,
                descripcion: description,
                localidad: location,
                duracion: duration + ' días',
                productos: selectedProducts,
                precio_total: selectedProducts.reduce((total, p) => total + p.precio, 0) + parseInt(price),
                precio: parseInt(price),
                fechaCreacion: new Date().toISOString(),
                creadoPor: 'admin'
            };

            // Guardar en localStorage como paquete de admin
            const adminPackages = JSON.parse(localStorage.getItem('admin_packages') || '[]');
            adminPackages.push(newPackage);
            localStorage.setItem('admin_packages', JSON.stringify(adminPackages));

            alert('Paquete creado exitosamente');
            closeCreatePackageModal();
            loadAllPackages();
        }

        function initializeAdminPage() {
            loadDashboardStats();
            loadProductsByCategory();
            loadRecentPackages();
            loadAllPackages();
            loadUsers();
        }

        function showSection(sectionName) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover active de todos los nav-links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Mostrar la sección seleccionada
            document.getElementById(sectionName + 'Section').classList.add('active');
            
            // Activar el nav-link correspondiente
            event.target.classList.add('active');

            // Cargar contenido específico de la sección
            if (sectionName === 'products') {
                showProductCategory('hoteles');
            }
        }

        function loadDashboardStats() {
            if (!products) return;

            const totalProducts = products.hoteles.length + products.restaurantes.length + 
                                products.actividades.length + products.comidas.length;
            
            document.getElementById('totalProducts').textContent = totalProducts;
            
            // Calcular total de paquetes de todos los usuarios
            let totalPackages = 0;
            for (let i = 1; i <= 10; i++) { // Asumiendo máximo 10 usuarios
                const userPackages = JSON.parse(localStorage.getItem(`packages_${i}`) || '[]');
                totalPackages += userPackages.length;
            }
            
            document.getElementById('totalPackages').textContent = totalPackages;
            document.getElementById('totalUsers').textContent = '10'; // Simulado
            document.getElementById('totalRevenue').textContent = '$0'; // Simulado
        }

        function loadProductsByCategory() {
            const container = document.getElementById('productsByCategory');
            if (!container || !products) return;

            const categories = [
                { name: 'Hoteles', count: products.hoteles.length, icon: 'bed' },
                { name: 'Restaurantes', count: products.restaurantes.length, icon: 'utensils' },
                { name: 'Actividades', count: products.actividades.length, icon: 'hiking' },
                { name: 'Comidas', count: products.comidas.length, icon: 'coffee' }
            ];

            container.innerHTML = categories.map(cat => `
                <div class="category-stat">
                    <i class="fas fa-${cat.icon}"></i>
                    <span>${cat.name}: ${cat.count}</span>
                </div>
            `).join('');
        }

        function loadRecentPackages() {
            const container = document.getElementById('recentPackages');
            if (!container) return;

            // Obtener paquetes recientes de todos los usuarios
            let allPackages = [];
            for (let i = 1; i <= 10; i++) {
                const userPackages = JSON.parse(localStorage.getItem(`packages_${i}`) || '[]');
                allPackages = allPackages.concat(userPackages);
            }

            // Ordenar por fecha de creación
            allPackages.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            const recentPackages = allPackages.slice(0, 5);

            if (recentPackages.length === 0) {
                container.innerHTML = '<p>No hay paquetes recientes</p>';
                return;
            }

            container.innerHTML = recentPackages.map(pkg => `
                <div class="package-item">
                    <div class="package-info">
                        <h4>${pkg.nombre}</h4>
                        <p>${pkg.localidad || 'Sin localidad'} - $${pkg.precio_total || 0}</p>
                    </div>
                    <div class="package-date">
                        ${new Date(pkg.fechaCreacion).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function loadAllPackages() {
            const container = document.getElementById('adminPackagesList');
            if (!container) return;

            // Obtener todos los paquetes de todos los usuarios
            let allPackages = [];
            for (let i = 1; i <= 10; i++) {
                const userPackages = JSON.parse(localStorage.getItem(`packages_${i}`) || '[]');
                allPackages = allPackages.concat(userPackages.map(pkg => ({...pkg, userId: i, type: 'user'})));
            }

            // Agregar paquetes creados por admin
            const adminPackages = JSON.parse(localStorage.getItem('admin_packages') || '[]');
            allPackages = allPackages.concat(adminPackages.map(pkg => ({...pkg, type: 'admin'})));

            if (allPackages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-suitcase"></i>
                        <h3>No hay paquetes creados</h3>
                        <p>Los usuarios aún no han creado paquetes</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allPackages.map(pkg => `
                <div class="package-card">
                    <div class="package-image">
                        <img src="https://placehold.co/600x300/1e3a8a/FFFFFF?text=Paquete" alt="${pkg.nombre}">
                    </div>
                    <div class="package-content">
                        <h3 class="package-title">${pkg.nombre}</h3>
                        <p class="package-description">${pkg.descripcion || 'Sin descripción'}</p>
                        
                        <div class="package-meta">
                            <span class="package-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${pkg.localidad || 'Sin localidad'}
                            </span>
                            <span class="package-user">
                                <i class="fas fa-${pkg.type === 'admin' ? 'crown' : 'user'}"></i>
                                ${pkg.type === 'admin' ? 'Admin' : `Usuario ${pkg.userId}`}
                            </span>
                        </div>
                        
                        <div class="package-footer">
                            <div class="package-price">
                                <span class="price-value">$${pkg.precio_total || pkg.precio || 0}</span>
                            </div>
                            
                            <div class="package-actions">
                                <button class="btn btn-danger btn-sm" onclick="deleteAdminPackage(${pkg.id}, ${pkg.userId})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadUsers() {
            const container = document.getElementById('usersList');
            if (!container) return;

            // Simular usuarios
            const users = [];
            for (let i = 1; i <= 10; i++) {
                const userPackages = JSON.parse(localStorage.getItem(`packages_${i}`) || '[]');
                users.push({
                    id: i,
                    name: `Usuario ${i}`,
                    email: `usuario${i}@ejemplo.com`,
                    packages: userPackages.length,
                    totalSpent: userPackages.reduce((total, pkg) => total + (pkg.precio_total || 0), 0)
                });
            }

            container.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <h3>${user.name}</h3>
                        <p>${user.email}</p>
                        <div class="user-stats">
                            <span><i class="fas fa-suitcase"></i> ${user.packages} paquetes</span>
                            <span><i class="fas fa-dollar-sign"></i> $${user.totalSpent}</span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showProductCategory(category) {
            currentProductCategory = category;
            
            // Actualizar tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Cargar productos de la categoría
            const container = document.getElementById('productsList');
            if (!container || !products) return;

            const categoryProducts = products[category] || [];

            container.innerHTML = categoryProducts.map(product => `
                <div class="product-card ${category}">
                    <div class="product-image">
                        <img src="${product.imagen}" alt="${product.nombre}">
                        <div class="product-category-badge">${getCategoryName(category)}</div>
                    </div>
                    <div class="product-content">
                        <h3 class="product-title">${product.nombre}</h3>
                        <p class="product-description">${product.descripcion}</p>
                        <div class="product-meta">
                            <span class="product-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${product.localidad}
                            </span>
                            <span class="product-price">$${product.precio}</span>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editProduct(${product.id}, '${category}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id}, '${category}')">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showAddProductModal() {
            const modal = document.getElementById('addProductModal');
            modal.style.display = 'flex';

            // Cargar localidades
            const locationSelect = document.getElementById('productLocation');
            if (products && products.localidades) {
                locationSelect.innerHTML = products.localidades.map(loc => 
                    `<option value="${loc.nombre}">${loc.nombre}</option>`
                ).join('');
            }
        }

        function showCreatePackageModal() {
            const modal = document.getElementById('createPackageModal');
            modal.style.display = 'flex';

            // Cargar localidades
            const locationSelect = document.getElementById('packageLocation');
            if (products && products.localidades) {
                locationSelect.innerHTML = products.localidades.map(loc => 
                    `<option value="${loc.nombre}">${loc.nombre}</option>`
                ).join('');
            }

            // Cargar productos para selección
            loadProductsForPackage();
        }

        function closeCreatePackageModal() {
            const modal = document.getElementById('createPackageModal');
            modal.style.display = 'none';
            document.getElementById('createPackageForm').reset();
        }

        function loadProductsForPackage() {
            const container = document.getElementById('packageProductsList');
            if (!container || !products) return;

            const allProducts = [
                ...products.hoteles.map(p => ({...p, categoria: 'hoteles'})),
                ...products.restaurantes.map(p => ({...p, categoria: 'restaurantes'})),
                ...products.actividades.map(p => ({...p, categoria: 'actividades'})),
                ...products.comidas.map(p => ({...p, categoria: 'comidas'}))
            ];

            container.innerHTML = allProducts.map(product => `
                <div class="product-selection-item">
                    <input type="checkbox" id="product_${product.id}" value="${product.id}">
                    <label for="product_${product.id}">
                        <span class="product-name">${product.nombre}</span>
                        <span class="product-price">$${product.precio}</span>
                        <span class="product-category">${getCategoryName(product.categoria)}</span>
                    </label>
                </div>
            `).join('');
        }

        function closeAddProductModal() {
            const modal = document.getElementById('addProductModal');
            modal.style.display = 'none';
            document.getElementById('addProductForm').reset();
        }

        function getCategoryName(category) {
            const names = {
                'hoteles': 'Hotel',
                'restaurantes': 'Restaurante',
                'actividades': 'Actividad',
                'comidas': 'Comida'
            };
            return names[category] || 'Producto';
        }

        function deleteAdminPackage(packageId, userId) {
            if (confirm('¿Estás seguro de que quieres eliminar este paquete?')) {
                const userPackages = JSON.parse(localStorage.getItem(`packages_${userId}`) || '[]');
                const updatedPackages = userPackages.filter(pkg => pkg.id !== packageId);
                localStorage.setItem(`packages_${userId}`, JSON.stringify(updatedPackages));
                loadAllPackages();
            }
        }

        function deleteUser(userId) {
            if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                localStorage.removeItem(`packages_${userId}`);
                loadUsers();
            }
        }

        function editProduct(productId, category) {
            alert('Funcionalidad de edición próximamente');
        }

        function deleteProduct(productId, category) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                alert('Funcionalidad de eliminación próximamente');
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
