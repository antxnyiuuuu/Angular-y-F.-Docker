<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viajes M√©xico - Perfil</title>
    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>Perfil</h1>
            <button class="profile-btn" onclick="navigateTo('profile')">
                <img src="../assets/images/avatar-user.webp" alt="Perfil" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDIxdi0yYTQgNCAwIDAgMC00LTRIOGE0IDQgMCAwIDAtNCA0djIiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'">
            </button>
        </header>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Informaci√≥n del perfil -->
            <section class="section">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <img src="../assets/images/avatar-user.webp" alt="Avatar" 
                         style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMDY2NjY2Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QXZhdGFyPC90ZXh0Pgo8L3N2Zz4K'">
                    <h2 id="userName">Usuario Demo</h2>
                    <p id="userEmail" style="color: #64748b;">usuario@demo.com</p>
                    <p id="userBio" style="color: #64748b; font-style: italic;">Viajero apasionado</p>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <button class="btn btn-secondary" onclick="showEditProfileModal()" style="flex: 1;">
                        Editar Perfil
                    </button>
                    <button class="btn btn-secondary" onclick="logout()" style="flex: 1;">
                        Cerrar Sesi√≥n
                    </button>
                </div>
            </section>

            <!-- Estad√≠sticas -->
            <section class="section">
                <h2 class="section-title">Mis Estad√≠sticas</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: 700; color: #0ea5e9;" id="packagesCount">0</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Paquetes Creados</div>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2rem; font-weight: 700; color: #06b6d4;" id="favoritesCount">0</div>
                        <div style="color: #64748b; font-size: 0.875rem;">Favoritos</div>
                    </div>
                </div>
            </section>

            <!-- Mis paquetes -->
            <section class="section">
                <h2 class="section-title">Mis Paquetes</h2>
                <div id="userPackagesList">
                    <!-- Se llena din√°micamente -->
                </div>
            </section>

            <!-- Favoritos -->
            <section class="section">
                <h2 class="section-title">Mis Favoritos</h2>
                <div id="userFavoritesList">
                    <!-- Se llena din√°micamente -->
                </div>
            </section>
        </main>

        <!-- Navegaci√≥n inferior -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" data-nav="home">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                <span class="nav-label">Inicio</span>
            </a>
            <a href="#" class="nav-item" data-nav="search">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span class="nav-label">Buscar</span>
            </a>
            <a href="#" class="nav-item" data-nav="mypackages">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                    <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                    <line x1="12" y1="22.08" x2="12" y2="12"/>
                </svg>
                <span class="nav-label">Mis Paquetes</span>
            </a>
            <a href="#" class="nav-item active" data-nav="profile">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span class="nav-label">Perfil</span>
            </a>
        </nav>

        <!-- Bot√≥n flotante -->
        <button class="floating-btn" data-modal="createPackageModal">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
        </button>
    </div>

    <script src="../assets/app.js"></script>
    <script>
        // Funciones espec√≠ficas de la p√°gina de perfil
        function loadProfileContent() {
            loadUserInfo();
            loadUserStats();
            loadUserPackages();
            loadUserFavorites();
        }

        function loadUserInfo() {
            const user = AppState.currentUser;
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userBio').textContent = user.bio || 'Viajero apasionado';
            }
        }

        function loadUserStats() {
            const userPackages = AppState.packages.filter(pkg => pkg.createdBy === AppState.currentUser.id);
            const favorites = AppState.favorites;
            
            document.getElementById('packagesCount').textContent = userPackages.length;
            document.getElementById('favoritesCount').textContent = favorites.length;
        }

        function loadUserPackages() {
            const container = document.getElementById('userPackagesList');
            const userPackages = AppState.packages.filter(pkg => pkg.createdBy === AppState.currentUser.id);
            
            if (userPackages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-title">No tienes paquetes creados</div>
                        <div class="empty-state-text">Crea tu primer paquete de viaje</div>
                    </div>
                `;
            } else {
                container.innerHTML = userPackages.slice(0, 3).map(pkg => createProfilePackageCard(pkg)).join('');
                
                if (userPackages.length > 3) {
                    container.innerHTML += `
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="navigateTo('mypackages')">
                                Ver Todos los Paquetes
                            </button>
                        </div>
                    `;
                }
            }
        }

        function createProfilePackageCard(pkg) {
            const totalPrice = calculatePackagePrice(pkg);
            
            return `
                <div class="card" style="margin-bottom: 1rem;" onclick="navigateTo('mypackages')">
                    <div style="display: flex; padding: 1rem;">
                        <img src="${generatePackageCover(pkg.id)}" alt="${pkg.name}" 
                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-right: 1rem;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDY2NjY2Ii8+Cjx0ZXh0IHg9IjQwIiB5PSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2VuIG5vIGRpc3BvbmlibGU8L3RleHQ+Cjwvc3ZnPgo='">
                        <div style="flex: 1;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">${pkg.name}</h3>
                            <p style="font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem;">${pkg.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.875rem; color: #64748b;">${pkg.items.length} items</span>
                                <span style="font-weight: 700; color: #0ea5e9;">$${totalPrice} MXN</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadUserFavorites() {
            const container = document.getElementById('userFavoritesList');
            const favorites = AppState.favorites;
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ù§Ô∏è</div>
                        <div class="empty-state-title">No tienes favoritos</div>
                        <div class="empty-state-text">Explora y marca tus lugares favoritos</div>
                    </div>
                `;
            } else {
                const favoriteItems = [];
                
                // Buscar los productos favoritos
                favorites.forEach(favId => {
                    const product = findProductById(favId);
                    if (product) {
                        favoriteItems.push(product);
                    }
                });
                
                container.innerHTML = favoriteItems.slice(0, 3).map(item => createFavoriteCard(item)).join('');
                
                if (favoriteItems.length > 3) {
                    container.innerHTML += `
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="navigateTo('search')">
                                Ver Todos los Favoritos
                            </button>
                        </div>
                    `;
                }
            }
        }

        function createFavoriteCard(item) {
            return `
                <div class="card" style="margin-bottom: 1rem;" onclick="navigateTo('search')">
                    <div style="display: flex; padding: 1rem;">
                        <img src="${item.image}" alt="${item.name}" 
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 1rem;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjMDY2NjY2Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD4KPC9zdmc+Cg=='">
                        <div style="flex: 1;">
                            <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">${item.name}</h3>
                            <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">${item.location || item.type || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: #64748b;">‚ù§Ô∏è Favorito</span>
                                <span style="font-weight: 600; color: #0ea5e9; font-size: 0.875rem;">$${item.price || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showEditProfileModal() {
            const user = AppState.currentUser;
            
            const modalHTML = `
                <div class="modal-overlay" id="editProfileModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h2 class="modal-title">Editar Perfil</h2>
                            <button class="modal-close" data-close-modal>&times;</button>
                        </div>
                        <div class="modal-content">
                            <form id="editProfileForm">
                                <div class="form-group">
                                    <label class="form-label" for="editName">Nombre</label>
                                    <input type="text" id="editName" class="form-input" value="${user.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editEmail">Email</label>
                                    <input type="email" id="editEmail" class="form-input" value="${user.email}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editBio">Biograf√≠a</label>
                                    <textarea id="editBio" class="form-input form-textarea" placeholder="Cu√©ntanos sobre ti...">${user.bio || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editAvatar">URL de Avatar</label>
                                    <input type="url" id="editAvatar" class="form-input" value="${user.avatar || ''}" placeholder="https://ejemplo.com/avatar.jpg">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-close-modal>Cancelar</button>
                            <button class="btn" onclick="saveProfileEdit()">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function saveProfileEdit() {
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const bio = document.getElementById('editBio').value;
            const avatar = document.getElementById('editAvatar').value;
            
            if (!name.trim() || !email.trim()) {
                showToast('Nombre y email son requeridos', 'error');
                return;
            }
            
            // Actualizar usuario actual
            AppState.currentUser.name = name;
            AppState.currentUser.email = email;
            AppState.currentUser.bio = bio;
            AppState.currentUser.avatar = avatar;
            
            // Actualizar en localStorage
            saveToLocalStorage('currentUser', AppState.currentUser);
            
            // Actualizar en la lista de usuarios
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === AppState.currentUser.id);
            if (userIndex > -1) {
                users[userIndex] = AppState.currentUser;
                saveToLocalStorage('users', users);
            }
            
            showToast('Perfil actualizado exitosamente');
            closeModal();
            loadUserInfo();
        }

        function calculatePackagePrice(pkg) {
            let totalPrice = 0;
            
            pkg.items.forEach(item => {
                const product = findProductById(item.id);
                if (product) {
                    if (item.type === 'restaurants') {
                        item.details.dishes.forEach(dish => {
                            const menuItem = product.dishes.find(d => d.name === dish.name);
                            if (menuItem) {
                                totalPrice += menuItem.price * dish.quantity;
                            }
                        });
                    } else {
                        totalPrice += product.price || 0;
                    }
                }
            });
            
            if (pkg.transport) {
                totalPrice += 50;
            }
            
            return totalPrice;
        }

        // Inicializar p√°gina
        if (AppState.currentPage === 'profile') {
            loadProfileContent();
        }
    </script>
</body>
</html>
