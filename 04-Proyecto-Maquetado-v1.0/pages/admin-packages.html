<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viajes México - Gestionar Paquetes</title>
    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>Gestionar Paquetes</h1>
            <button class="profile-btn" onclick="logout()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>
        </header>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Botón crear paquete -->
            <div style="margin-bottom: 1.5rem;">
                <button class="btn btn-large" onclick="showCreateAdminPackageModal()" style="width: 100%;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Crear Nuevo Paquete
                </button>
            </div>

            <!-- Filtros -->
            <div class="quick-filters" style="margin-bottom: 1.5rem;">
                <button class="filter-btn active" data-filter="all">Todos</button>
                <button class="filter-btn" data-filter="admin">Creados por Admin</button>
                <button class="filter-btn" data-filter="users">Creados por Usuarios</button>
            </div>

            <!-- Lista de paquetes -->
            <section class="section">
                <div class="package-list" id="adminPackagesList">
                    <!-- Se llena dinámicamente -->
                </div>
            </section>

            <!-- Estado vacío -->
            <div class="empty-state hidden" id="emptyState">
                <div class="empty-state-icon">📦</div>
                <div class="empty-state-title">No hay paquetes</div>
                <div class="empty-state-text">Crea el primer paquete para los usuarios</div>
            </div>
        </main>

        <!-- Navegación inferior -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item" data-nav="admin-home">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                </svg>
                <span class="nav-label">Admin</span>
            </a>
            <a href="#" class="nav-item" data-nav="admin-add">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span class="nav-label">Agregar</span>
            </a>
            <a href="#" class="nav-item active" data-nav="admin-packages">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                </svg>
                <span class="nav-label">Paquetes</span>
            </a>
            <a href="#" class="nav-item" data-nav="admin-transport">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3h18v18H3zM9 9h6v6H9z"/>
                </svg>
                <span class="nav-label">Transporte</span>
            </a>
        </nav>
    </div>

    <script src="../assets/app.js"></script>
    <script>
        // Funciones específicas de la página admin packages
        function loadAdminPackagesContent() {
            loadAdminPackages();
            setupFilterButtons();
        }

        function loadAdminPackages(filter = 'all') {
            const container = document.getElementById('adminPackagesList');
            const emptyState = document.getElementById('emptyState');
            
            let packages = AppState.packages;
            
            // Aplicar filtro
            if (filter === 'admin') {
                packages = packages.filter(pkg => pkg.createdBy === 'admin');
            } else if (filter === 'users') {
                packages = packages.filter(pkg => pkg.createdBy !== 'admin');
            }
            
            if (packages.length === 0) {
                container.style.display = 'none';
                emptyState.classList.remove('hidden');
            } else {
                container.style.display = 'block';
                emptyState.classList.add('hidden');
                
                container.innerHTML = packages.map(pkg => createAdminPackageCard(pkg)).join('');
            }
        }

        function createAdminPackageCard(pkg) {
            const isAdminPackage = pkg.createdBy === 'admin';
            const creatorName = isAdminPackage ? 'Admin' : 'Usuario';
            const totalPrice = calculatePackagePrice(pkg);
            
            return `
                <div class="package-card">
                    <img src="${pkg.image}" alt="${pkg.name}" class="package-image" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDQwMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMTUwIiBmaWxsPSIjMDY2NjY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlbiBubyBkaXNwb25pYmxlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="package-info">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <h3 class="package-title">${pkg.name}</h3>
                            <span style="background: ${isAdminPackage ? '#0ea5e9' : '#10b981'}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                ${creatorName}
                            </span>
                        </div>
                        <p class="package-description">${pkg.description}</p>
                        <div class="package-meta">
                            <span class="package-duration">${pkg.items.length} items</span>
                            <span class="package-price">$${totalPrice} MXN</span>
                        </div>
                        <div class="package-actions">
                            <button class="btn btn-small" onclick="viewPackageDetails('${pkg.id}')">
                                Ver Detalles
                            </button>
                            ${isAdminPackage ? `
                                <button class="btn btn-small btn-secondary" onclick="editAdminPackage('${pkg.id}')">
                                    Editar
                                </button>
                                <button class="btn btn-small" onclick="deletePackage('${pkg.id}')" style="background: #ef4444; color: white;">
                                    Eliminar
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function setupFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover active de todos
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    // Agregar active al clickeado
                    this.classList.add('active');
                    
                    const filter = this.getAttribute('data-filter');
                    loadAdminPackages(filter);
                });
            });
        }

        function showCreateAdminPackageModal() {
            const modalHTML = `
                <div class="modal-overlay" id="createAdminPackageModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h2 class="modal-title">Crear Paquete Admin</h2>
                            <button class="modal-close" data-close-modal>&times;</button>
                        </div>
                        <div class="modal-content">
                            <form id="createAdminPackageForm">
                                <div class="form-group">
                                    <label class="form-label" for="adminPackageName">Nombre del Paquete</label>
                                    <input type="text" id="adminPackageName" class="form-input" required 
                                           placeholder="Paquete de Ejemplo">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="adminPackageDescription">Descripción</label>
                                    <textarea id="adminPackageDescription" class="form-input form-textarea" 
                                              placeholder="Descripción del paquete..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="adminPackagePrice">Precio Base (MXN)</label>
                                    <input type="number" id="adminPackagePrice" class="form-input" min="0" step="0.01"
                                           placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="adminPackageDuration">Duración</label>
                                    <input type="text" id="adminPackageDuration" class="form-input" 
                                           placeholder="3 días / 2 noches">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="adminPackageImage">URL de Imagen</label>
                                    <input type="url" id="adminPackageImage" class="form-input" 
                                           placeholder="https://ejemplo.com/imagen.jpg">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-close-modal>Cancelar</button>
                            <button class="btn" onclick="createAdminPackage()">Crear Paquete</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function createAdminPackage() {
            const name = document.getElementById('adminPackageName').value;
            const description = document.getElementById('adminPackageDescription').value;
            const price = parseFloat(document.getElementById('adminPackagePrice').value) || 0;
            const duration = document.getElementById('adminPackageDuration').value;
            const image = document.getElementById('adminPackageImage').value;
            
            if (!name.trim()) {
                showToast('El nombre del paquete es requerido', 'error');
                return;
            }
            
            const newPackage = {
                id: 'pkg_' + Date.now(),
                name: name,
                description: description || 'Paquete creado por administrador',
                image: image || 'assets/images/placeholder.webp',
                price: price,
                duration: duration || 'Personalizado',
                createdBy: 'admin',
                items: [],
                createdAt: new Date().toISOString()
            };
            
            AppState.packages.push(newPackage);
            saveToLocalStorage('packages', AppState.packages);
            
            showToast('Paquete creado exitosamente');
            closeModal();
            loadAdminPackages();
        }

        function viewPackageDetails(packageId) {
            const pkg = AppState.packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const totalPrice = calculatePackagePrice(pkg);
            const isAdminPackage = pkg.createdBy === 'admin';
            
            const modalHTML = `
                <div class="modal-overlay" id="packageDetailsModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h2 class="modal-title">${pkg.name}</h2>
                            <button class="modal-close" data-close-modal>&times;</button>
                        </div>
                        <div class="modal-content">
                            <img src="${pkg.image}" alt="${pkg.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDQwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI0MDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjMDY2NjY2Ii8+Cjx0ZXh0IHg9IjIwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JbWFnZW4gbm8gZGlzcG9uaWJsZTwvdGV4dD4KPC9zdmc+Cg=='">
                            <p style="margin-bottom: 1rem; line-height: 1.6;">${pkg.description}</p>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span><strong>Creado por:</strong> ${isAdminPackage ? 'Admin' : 'Usuario'}</span>
                                <span><strong>Precio:</strong> $${totalPrice} MXN</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong>Items incluidos (${pkg.items.length}):</strong>
                                <div style="margin-top: 0.5rem;">
                                    ${pkg.items.length === 0 ? 
                                        '<p style="color: #64748b; font-style: italic;">No hay items agregados</p>' :
                                        pkg.items.map(item => {
                                            const product = findProductById(item.id);
                                            return `<div style="padding: 0.5rem; background: #f8fafc; border-radius: 4px; margin-bottom: 0.5rem;">
                                                <div style="font-weight: 600;">${product ? product.name : 'Item'}</div>
                                                ${item.details.guests ? `<div style="font-size: 0.875rem; color: #64748b;">${item.details.guests} personas</div>` : ''}
                                                ${item.details.checkIn ? `<div style="font-size: 0.875rem; color: #64748b;">${item.details.checkIn} - ${item.details.checkOut}</div>` : ''}
                                                ${item.details.dishes ? `
                                                    <div style="font-size: 0.875rem; color: #64748b;">
                                                        ${item.details.dishes.map(dish => `${dish.name} (${dish.quantity})`).join(', ')}
                                                    </div>
                                                ` : ''}
                                            </div>`;
                                        }).join('')
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-close-modal>Cerrar</button>
                            ${isAdminPackage ? `
                                <button class="btn" onclick="editAdminPackage('${pkg.id}')">Editar</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function editAdminPackage(packageId) {
            const pkg = AppState.packages.find(p => p.id === packageId);
            if (!pkg) return;
            
            const modalHTML = `
                <div class="modal-overlay" id="editAdminPackageModal">
                    <div class="modal">
                        <div class="modal-header">
                            <h2 class="modal-title">Editar Paquete</h2>
                            <button class="modal-close" data-close-modal>&times;</button>
                        </div>
                        <div class="modal-content">
                            <form id="editAdminPackageForm">
                                <div class="form-group">
                                    <label class="form-label" for="editAdminPackageName">Nombre del Paquete</label>
                                    <input type="text" id="editAdminPackageName" class="form-input" value="${pkg.name}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editAdminPackageDescription">Descripción</label>
                                    <textarea id="editAdminPackageDescription" class="form-input form-textarea">${pkg.description}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editAdminPackagePrice">Precio Base (MXN)</label>
                                    <input type="number" id="editAdminPackagePrice" class="form-input" value="${pkg.price}" min="0" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editAdminPackageDuration">Duración</label>
                                    <input type="text" id="editAdminPackageDuration" class="form-input" value="${pkg.duration}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="editAdminPackageImage">URL de Imagen</label>
                                    <input type="url" id="editAdminPackageImage" class="form-input" value="${pkg.image}">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-close-modal>Cancelar</button>
                            <button class="btn" onclick="saveAdminPackageEdit('${packageId}')">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function saveAdminPackageEdit(packageId) {
            const name = document.getElementById('editAdminPackageName').value;
            const description = document.getElementById('editAdminPackageDescription').value;
            const price = parseFloat(document.getElementById('editAdminPackagePrice').value) || 0;
            const duration = document.getElementById('editAdminPackageDuration').value;
            const image = document.getElementById('editAdminPackageImage').value;
            
            if (!name.trim()) {
                showToast('El nombre del paquete es requerido', 'error');
                return;
            }
            
            const packageIndex = AppState.packages.findIndex(p => p.id === packageId);
            if (packageIndex > -1) {
                AppState.packages[packageIndex].name = name;
                AppState.packages[packageIndex].description = description;
                AppState.packages[packageIndex].price = price;
                AppState.packages[packageIndex].duration = duration;
                AppState.packages[packageIndex].image = image;
                
                saveToLocalStorage('packages', AppState.packages);
                
                showToast('Paquete actualizado exitosamente');
                closeModal();
                loadAdminPackages();
            }
        }

        function deletePackage(packageId) {
            if (confirm('¿Estás seguro de que quieres eliminar este paquete?')) {
                const packageIndex = AppState.packages.findIndex(p => p.id === packageId);
                if (packageIndex > -1) {
                    AppState.packages.splice(packageIndex, 1);
                    saveToLocalStorage('packages', AppState.packages);
                    
                    showToast('Paquete eliminado exitosamente');
                    loadAdminPackages();
                }
            }
        }

        function calculatePackagePrice(pkg) {
            let totalPrice = pkg.price || 0;
            
            pkg.items.forEach(item => {
                const product = findProductById(item.id);
                if (product) {
                    if (item.type === 'restaurants') {
                        item.details.dishes.forEach(dish => {
                            const menuItem = product.dishes.find(d => d.name === dish.name);
                            if (menuItem) {
                                totalPrice += menuItem.price * dish.quantity;
                            }
                        });
                    } else {
                        totalPrice += product.price || 0;
                    }
                }
            });
            
            if (pkg.transport) {
                totalPrice += 50;
            }
            
            return totalPrice;
        }

        // Inicializar página
        if (AppState.currentPage === 'admin-packages') {
            loadAdminPackagesContent();
        }
    </script>
</body>
</html>
